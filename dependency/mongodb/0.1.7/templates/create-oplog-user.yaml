{{- define "mongodb.configmap" -}}

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "common.names.fullname" . }}-create-oplog-user
  labels:
    {{- include "common.labels" . | nindent 4 }}
data:
  create-oplog-user.sh: |-
    #!/bin/bash

    echo "Generating command for oplog user creation...";
    # '.script' extension is just to avoid the bitnami init script to executing it. (bitnami executes .sh and .js files automatically)
    echo 'use '$MONGODB_DATABASE > /docker-entrypoint-initdb.d/createOpLogUser.script;
    echo 'db.createUser({user: "'$MONGODB_USERNAME'-oplog", pwd: "'$MONGODB_PASSWORD'", roles: [ { role: "read", db: "local" } ]})' >> /docker-entrypoint-initdb.d/createOpLogUser.script;
    echo 'hostname()' >> /docker-entrypoint-initdb.d/createOpLogUser.script;
    echo "Command Generated!";

    echo "Creating the user...";
    mongo admin -u root -p $MONGODB_ROOT_PASSWORD < /docker-entrypoint-initdb.d/createOpLogUser.script;
    echo "User Created!";

    echo "Removing mongodb generated command"...;
    rm /docker-entrypoint-initdb.d/createOpLogUser.script;
    echo "Removed mongodb generated command!";
{{- end -}}
